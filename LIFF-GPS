<!DOCTYPE html>
<html>
<head>
  <title>LINE GPS æ‰“å¡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>ğŸ”’ æ­£åœ¨é©—è­‰å®šä½...</h2>
  <script>
    const COMPANY_LAT = 25.0497652;
    const COMPANY_LNG = 121.2855485;
    const RADIUS_KM = 0.2;

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    async function main() {
      await liff.init({ liffId: "ğŸ”‘ ä½ çš„ LIFF ID" }); // ğŸ‘ˆ æ›¿æ›ç‚ºä½ å‰›å‰›å»ºç«‹çš„ LIFF ID

      navigator.geolocation.getCurrentPosition(async position => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const dist = getDistance(lat, lng, COMPANY_LAT, COMPANY_LNG);
        const isInRange = dist <= RADIUS_KM;

        const msg = isInRange ? "âœ… æ‰“å¡æˆåŠŸï¼" : "âŒ è¶…å‡ºç¯„åœï¼Œè«‹è‡³å…¬å¸å…§æ‰“å¡";
        alert(msg);

        // å›å‚³è‡³ Google Sheet æˆ–è³‡æ–™åº«ï¼ˆä¾‹å¦‚å‘¼å« Web App URLï¼‰
        await fetch("https://script.google.com/macros/s/XXXXXX/exec", {
          method: "POST",
          body: JSON.stringify({
            userId: liff.getContext().userId,
            latitude: lat,
            longitude: lng,
            status: isInRange ? "æˆåŠŸ" : "å¤±æ•—"
          }),
          headers: { "Content-Type": "application/json" }
        });

        liff.closeWindow();
      }, () => {
        alert("â— è«‹é–‹å•Ÿ GPS ä»¥å®Œæˆæ‰“å¡");
      });
    }

    main();
  </script>
</body>
</html>
