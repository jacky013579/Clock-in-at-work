<!DOCTYPE html>
<html>
<head>
  <title>LINE GPS 打卡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>🔒 正在驗證定位...</h2>
  <script>
    const COMPANY_LAT = 25.0497652;
    const COMPANY_LNG = 121.2855485;
    const RADIUS_KM = 0.2;

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    async function main() {
      await liff.init({ liffId: "🔑 你的 LIFF ID" }); // 👈 替換為你剛剛建立的 LIFF ID

      navigator.geolocation.getCurrentPosition(async position => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const dist = getDistance(lat, lng, COMPANY_LAT, COMPANY_LNG);
        const isInRange = dist <= RADIUS_KM;

        const msg = isInRange ? "✅ 打卡成功！" : "❌ 超出範圍，請至公司內打卡";
        alert(msg);

        // 回傳至 Google Sheet 或資料庫（例如呼叫 Web App URL）
        await fetch("https://script.google.com/macros/s/XXXXXX/exec", {
          method: "POST",
          body: JSON.stringify({
            userId: liff.getContext().userId,
            latitude: lat,
            longitude: lng,
            status: isInRange ? "成功" : "失敗"
          }),
          headers: { "Content-Type": "application/json" }
        });

        liff.closeWindow();
      }, () => {
        alert("❗ 請開啟 GPS 以完成打卡");
      });
    }

    main();
  </script>
</body>
</html>
